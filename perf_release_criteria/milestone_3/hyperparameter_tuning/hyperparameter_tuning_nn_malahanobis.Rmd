---
title: "Milestone 2: Hyperparameter Tuning - Nearest Neighbors, Mahalanobis"
author: "Corey Dow-Hygelund, Mozilla Data Science"
date: 'Last Updated: `r format(Sys.time(), "%B %d, %Y")`'
output: 
  html_notebook:
    theme: cosmo
    toc: true
    toc_float: true
---

# tl;dr

This analysis determines the optimal [hyperparameters] (https://docs.google.com/document/d/1SfuanvmYmvmEFAdQ7Z5djDeLezdNB1TESqVmj93O8to/edit#heading=h.yqukkyb8q4xw) to utilize for computationally intensive statistical matching algorithms proposed in the modeling approach for this [PRD](https://docs.google.com/document/d/1Ygz6MkudYHZjnDnD9Z97kUyFrvV3KGWsjXyPjddhHq0/edit#heading=h.lvb9l8gw2nee). 

**Matching Algorithm Tested**: Nearest-neighbors with Mahalanobis distance metric

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source('../lib/supporting_funcs.R')
source('../lib/scoring.R')
library(MatchIt)
```

```{r data_load, echo=FALSE}
file_name = 'df_train_validate_20191025.RData'
image_file_path = file.path('data', file_name)

# Pull from GCP if necessary
# library(googleCloudStorageR)
# Sys.setenv("GCS_DEFAULT_BUCKET" = "moz-fx-dev-subbeta",
#            "GCS_AUTH_FILE" = "moz-fx-dev-cdowhyglund-subBeta-788f8f0d4627.json")
# gcs_get_object(file.path('data', 'milestone2', file_name), saveToDisk = image_file_path, overwrite = TRUE)

load(image_file_path)
```

```{r bts, echo=FALSE}
bts = list(
  bts_1x = bts.1x,
  bts_4x = bts.4x,
  bts_8x = bts.8x,
  bts_16x = bts.16x
)

perf_metrics <- names(get_m2_metric_map())

covs <- df_train_f %>%
  select(-perf_metrics) %>%
  select(-content_crashes) %>%
  select(-client_id) %>%
  select(-label) %>%
  select(-is_release) %>%
  select(-app_version) %>%
  select_if(is.numeric) %>% # Mahalanobis constraint
  names()
  

results_file_name <- 'hyperparameter_tuning_nn_mahalanobis.RData' 
results_file_path <- file.path('data', results_file_name)
```

# Features
The optimal feature set was found in `feature_selection_nn_mahalanobis.Rmd`. At the time of this run they were:

* Beta oversampling by 4x
* FS 1: Only performance metrics

To investigate, and possible utilize, a more general model, the second highest suite of features will also be tested:

* Beta oversapmling by 16x
* FS 3: Performance metrics and highest found by Boruta with equal labels dataset


```{r boruta_import, echo=FALSE, warning=FALSE, message=FALSE}
file_name = 'feature_selection_boruta_initial_20191023.RData'
image_file_path = file.path('data', file_name)

# Sys.setenv("GCS_DEFAULT_BUCKET" = "moz-fx-dev-subbeta",
#            "GCS_AUTH_FILE" = "moz-fx-dev-cdowhyglund-subBeta-788f8f0d4627.json")
# library(googleCloudStorageR)
# gcs_get_object(file.path('data', 'milestone2', file_name), saveToDisk = image_file_path, overwrite = TRUE)

load(image_file_path)
```

```{r boruta_fs, echo=FALSE, warning=FALSE, message=FALSE}
extract_boruta_fs <- function(boruta_res, num=5){
  features <- NULL
  for(metric in names(boruta_results)){
    features <- c(names(sort(apply(boruta_res[[metric]]$ImpHistory, 2, median), decreasing = TRUE)[1:num]), features)
  }
  return(sort(unique(features)))
}

features_top10 <- extract_boruta_fs(boruta_results, num=10)
features_top10_eq <- extract_boruta_fs(boruta_results_eq, num=10)

# filter out categorical
features_top10 <- df_train_f %>% select(features_top10) %>% select_if(is.numeric) %>% names()
features_top10_eq <- df_train_f %>% select(features_top10_eq) %>% select_if(is.numeric) %>% names()
```

```{r feature_sets}
fs1 <- perf_metrics
fs2 <- c(names(fs1), features_top10)
fs3 <- c(names(fs1), features_top10_eq)
fs4 <- c(names(fs1), covs)
fs5 <- features_top10
fs6 <- features_top10_eq
fs7 <- covs
```


# Hyperparameters
Hyperparameters tested for nearest-neighbors are the following:

* Matching order (m.order)
* Caliper
* of control to treatments

```{r hyperparameters}
hps <- list(
  replace = c(TRUE, FALSE),
  caliper = c(0, 0.25, 0.5, 1, 3),
  calclosest = c(TRUE, FALSE),
  ratio = c(1, 2, 4)
)

hps_grid = expand.grid(hps)
```

# FS 1
Hyperparameter tuning on optimal features. 

```{r fs1, error=TRUE}
bt <- bts[['bts_4x']]

perform_matchit_hp_tune(df_train_f, bt[[1]], fs1, size=5000, workers = 10, hps_grid = hps_grid, distance = "mahalanobis")
```


