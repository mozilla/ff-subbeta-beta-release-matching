---
title: "Mozilla Data Science Project - 2019"
author: "Mariana de Oliveira Santos Silva"
date: "December 05, 2019"
output: 
  html_document:
    toc: true
    theme: united
    highlight: tango
    df_print: kable
---

# Exploratory Data Analysis (EDA) {.tabset}

This R markdown covers the Exploratory Data Analysis (EDA) on the training dataset of the PRD. 

## Setting-up
```{r message=FALSE, warning=FALSE}
## Loading the needed libraries

library(kableExtra)      # help you build common complex tables and manipulate table styles
library(tidyverse)       # for general data wrangling (includes readr and dplyr)
library(ggplot2)         # to draw statistical plots 
library(plotly)          # to construct interactive 3d plots
library(DataExplorer)    # automated data exploration
library(corrplot)        # to plot nice correlation matrix
library(caret)           # includes several functions to pre-process
library(scales)          # to determining breaks and labels for axes and legends
library(skimr)
library(funModeling) 
library(Hmisc)
library(grid)
library(hrbrthemes)
library(tidyr)
library(viridis)
library(ggpubr)
library(ggthemes)
library(GGally)
```

```{r message=FALSE, warning=FALSE}
## Loading the training dataset

load("~/GitHub/ff-beta-release-matching/poc/EDA/data_milestone2_df_train_validate_20191025.RData")
```

```{r message=FALSE, warning=FALSE}
## View train dataframe 

kable(head(df_train_f)) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
scroll_box(width = "100%")
```

## Step 1 : Data Inspection

To get introduced to our dataset, et's have a look on the basic information of the dataset.

```{r echo=FALSE}
kable(introduce(df_train_f)) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
scroll_box(width = "100%")
```

```{r echo=FALSE, fig.height=10, fig.width=10}
plot_intro(df_train_f, ggtheme = theme_minimal())
```

### Observations

* Most of the dataset is composed of continuous variables
* No NAs values (were handled in preprocessing)

### Structure

Let's use `glimpse` function to display a vertical preview of the dataset. So we can easily preview data type and sample data.

```{r}
glimpse(df_train_f)
```

If we want to get some metrics about data types, zeros, infinite numbers, and missing values, we can use the `df_status` function.

```{r}
kable(df_status(df_train_f, FALSE)) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
scroll_box(width = "100%")
```

* `q_zeros`: quantity of zeros (`p_zeros`: in percent)
* `q_inf`: quantity of infinite values (`p_inf`: in percent)
* `q_na`: quantity of NA (`p_na`: in percent)
* `type`: factor, ordered-factor, numeric, integer or character
* `unique`: quantity of unique values

#### Observations

> Are all the variables in the correct data type?

None. It seems that this has already been dealt with in preprocessing. 

> Any variables with lots of zeros? 

Yes. Variables with lots of zeros may not be useful for modeling and, in some cases, they may dramatically bias the model. For example, the `content_crashes` is 100% equal to zero.  

> Any variables with lots of NAs? 

None. Good news.

> Any high cardinality variable?

Factor/categorical variables with a high number of different values (~30) tend to do overfitting if the categories have low cardinality.

## Step 2 : Beta vs Release

```{r, fig.width = 7.5}
df_release <- df_train_f[which(df_train_f$label == 'release'), ]
df_beta <- df_train_f[which(df_train_f$label == 'beta'), ]

f <- freq(df_train_f$label)
```


```{r}
summary(df_release)
```


```{r}
summary(df_beta)
```

## Step 3 - Analyzing Discrete Variables

```{r, fig.width = 15, fig.height = 15}
## Frequency distribution release dataframe
plot_bar(df_release, ggtheme = theme_minimal(base_size = 15))
```

```{r, fig.width = 15, fig.height = 15}
## Frequency distribution beta dataframe
plot_bar(df_beta, ggtheme = theme_minimal(base_size = 15))
```

## Step 4 - Analyzing Continuos Variables

```{r, fig.width = 15, fig.height = 15}
## View histogram of release dataset
plot_histogram(df_release, ggtheme = theme_minimal(base_size = 15))
```

```{r, fig.width = 15, fig.height = 15}
## View histogram of beta dataset
plot_histogram(df_beta, ggtheme = theme_minimal(base_size = 15))
```

### Analysing User Engagement Metrics

```{r message=FALSE, warning=FALSE}
ggplot(data=df_train_f, aes(x=uri_count, group=label, fill=label)) +
    geom_density(adjust=1.5, alpha=0.6) + xlim(0, 1000) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    labs(title="URI Count Density Curve",x="URI Count", y = "Density") +
    theme_ipsum()
```

```{r message=FALSE, warning=FALSE}
ggplot(data=df_train_f, aes(x=active_hours, group=label, fill=label)) +
    geom_density(adjust=1.5, alpha=0.6) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    labs(title="Active Hours Density Curve",x="Active Hours", y = "Density") +
    theme_ipsum()
```

```{r message=FALSE, warning=FALSE}
ggplot(data=df_train_f, aes(x=num_pages, group=label, fill=label)) +
    geom_density(adjust=1.5, alpha=0.6) + xlim(0, 50000) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    labs(title="Num Pages Density Curve",x="Num Pages", y = "Density") +
    theme_ipsum()
```

```{r message=FALSE, warning=FALSE}
ggplot(data=df_train_f, aes(x=session_length, group=label, fill=label)) +
    geom_density(adjust=1.5, alpha=0.6, main="Session Length") + xlim(0, 75) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    labs(title="Session Length Density Curve",x="Session Length", y = "Density") +
    theme_ipsum()
```

# User Engagement Metrics {.tabset}

This project will focus on user engagement metrics to ensure the most performant model possible. So, we are going to analyze the following metrics:

* `num_active_days`
* `active_hours`
* `active_hours_max`
* `uri_count`
* `uri_count_max`
* `session_length`
* `session_length_max`
* `search_count`
* `search_count_max`
* `num_bookmarks`
* `num_pages`
* `num_pages_max`
* `daily_unique_domains`
* `daily_max_tabs`
* `daily_tabs_opened`
* `daily_num_sessions_started`
* `daily_unique_domains_max`
* `daily_max_tabs_max`
* `daily_tabs_opened_max`
* `daily_num_sessions_started_max`
<!-- * `fxa_configured` -->
<!-- * `sync_configured` -->

```{r include=FALSE}
user_eng <- c("num_active_days", "active_hours", "active_hours_max", "uri_count", "uri_count_max", "session_length", "session_length_max", "search_count", "search_count_max", "num_bookmarks", "num_pages", "num_pages_max", "daily_unique_domains", "daily_max_tabs", "daily_tabs_opened", "daily_num_sessions_started", "daily_unique_domains_max", "daily_max_tabs_max", "daily_tabs_opened_max", "daily_num_sessions_started_max")
```

```{r include=FALSE}
df_beta_ue <- df_beta %>% select(user_eng)
df_release_ue <- df_release %>% select(user_eng)
df_train_ue <- df_train_f %>% select(c(user_eng, "label"))
```

## Comparing Two Distributions

The QQ plot can be used to compare two continuous distributions. 

```{r}
par(mfrow = c(2, 2))  ## Set up a 2 x 2 plotting space

## QQ plot in R to compare two data samples
for (i in user_eng) {
  x <- df_beta_ue[,i]
  y <- df_release_ue[,i]
  
  rg <- range(x, y, na.rm=T)
  
  qqplot(x, y, main=i, xlim=rg, ylim=rg, xlab = "Beta", ylab = "Release", pch = 1, frame = FALSE)
}
```

```{r include=FALSE}
text_tbl <- data.frame(beta_num_active_days = c(summary(df_beta_ue$num_active_days)), release_num_active_days = c(summary(df_release_ue$num_active_days)), 
beta_active_hours = c(summary(df_beta_ue$active_hours)), release_active_hours = c(summary(df_release_ue$active_hours)), 
beta_active_hours_max = c(summary(df_beta_ue$active_hours_max)), release_active_hours_max = c(summary(df_release_ue$active_hours_max)), 
beta_uri_count = c(summary(df_beta_ue$uri_count)), release_uri_count = c(summary(df_release_ue$uri_count)), 
beta_uri_count_max = c(summary(df_beta_ue$uri_count_max)), release_uri_count_max = c(summary(df_release_ue$uri_count_max)), 
beta_session_length = c(summary(df_beta_ue$session_length)), release_session_length = c(summary(df_release_ue$session_length)), 
beta_session_length_max = c(summary(df_beta_ue$session_length_max)), release_session_length_max = c(summary(df_release_ue$session_length_max)), 
beta_search_count = c(summary(df_beta_ue$search_count)), release_search_count = c(summary(df_release_ue$search_count)), 
beta_search_count_max = c(summary(df_beta_ue$search_count_max)), release_search_count_max = c(summary(df_release_ue$search_count_max)), 
beta_num_bookmarks = c(summary(df_beta_ue$num_bookmarks)), release_num_bookmarks = c(summary(df_release_ue$num_bookmarks)), 
beta_num_pages = c(summary(df_beta_ue$num_pages)), release_num_pages = c(summary(df_release_ue$num_pages)), 
beta_num_pages_max = c(summary(df_beta_ue$num_pages_max)), release_num_pages_max = c(summary(df_release_ue$num_pages_max)), 
beta_daily_unique_domains = c(summary(df_beta_ue$daily_unique_domains)), release_daily_unique_domains = c(summary(df_release_ue$daily_unique_domains)), 
beta_daily_max_tabs = c(summary(df_beta_ue$daily_max_tabs)), release_daily_max_tabs = c(summary(df_release_ue$daily_max_tabs)), 
beta_daily_tabs_opened = c(summary(df_beta_ue$daily_tabs_opened)), release_daily_tabs_opened = c(summary(df_release_ue$daily_tabs_opened)), 
beta_daily_num_sessions_started = c(summary(df_beta_ue$daily_num_sessions_started)), release_daily_num_sessions_started = c(summary(df_release_ue$daily_num_sessions_started)), 
beta_daily_unique_domains_max = c(summary(df_beta_ue$daily_unique_domains_max)), release_daily_unique_domains_max = c(summary(df_release_ue$daily_unique_domains_max)), 
beta_daily_max_tabs_max = c(summary(df_beta_ue$daily_max_tabs_max)), release_daily_max_tabs_max = c(summary(df_release_ue$daily_max_tabs_max)), 
beta_daily_tabs_opened_max = c(summary(df_beta_ue$daily_tabs_opened_max)), release_daily_tabs_opened_max = c(summary(df_release_ue$daily_tabs_opened_max)), 
beta_daily_num_sessions_started_max = c(summary(df_beta_ue$daily_num_sessions_started_max)), release_daily_num_sessions_started_max = c(summary(df_release_ue$daily_num_sessions_started_max)))
```

```{r}
kable(text_tbl) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
scroll_box(width = "100%")
```





